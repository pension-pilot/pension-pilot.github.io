@using System.IO
@using PensionPilot.Models.Config
@using PensionPilot.Models.Tax
@using System.Text.Json
@inherits ComponentBase

@if (Config is null)
{
    <p>Loading...</p>
}
else
{
    @if (Config.Taxes.IncomeTaxBrackets is null || Config.Taxes.IncomeTaxBrackets.Count == 0)
    {
        <div class="alert alert-warning">
            Income Tax Brackets are empty.
            @if (ShowReloadDefaults)
            {
                <button class="btn btn-sm btn-cyan-outline" @onclick="OnReloadDefaults">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                    Reload defaults
                </button>
            }
        </div>
    }
    <EditForm EditContext="_editContext" OnValidSubmit="HandleSave">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="border rounded p-2">
            <h5 class="mb-2">Timeline</h5>
            <div class="row g-2">
            <div class="col-md-3">
                <label>Current Age</label>
                <InputNumber TValue="int" class="form-control" @bind-Value="Config.Timeline.CurrentAge" />
            </div>
            <div class="col-md-3">
                <label>Retirement Age</label>
                <InputNumber TValue="int" class="form-control" @bind-Value="Config.Timeline.RetirementAge" />
            </div>
            <div class="col-md-3">
                <label>Pension Age</label>
                <InputNumber TValue="int" class="form-control" @bind-Value="Config.Timeline.PensionAge" />
            </div>
            <div class="col-md-3">
                <label>Model End Age</label>
                <InputNumber TValue="int" class="form-control" @bind-Value="Config.Timeline.ModelEndAge" />
            </div>
            </div>
        </div>

        <div class="border rounded p-2 mt-3">
            <h5 class="mb-2">Taxes</h5>
            <div class="mb-2 d-flex align-items-end gap-2">
                <div class="flex-grow-1">
                    <label>Capital Gains Rate</label>
                    <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Taxes.CapitalGainsRate" />
                </div>
                @if (ShowReloadDefaults)
                {
                    <button type="button" class="btn btn-outline-secondary" title="Reload Defaults" @onclick="OnReloadDefaults">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>
                        Reload Defaults
                    </button>
                }
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="m-0">Income Tax Brackets (@(Config.Taxes.IncomeTaxBrackets?.Count ?? 0))</h6>
                <button type="button" class="btn btn-sm btn-cyan-outline" @onclick="AddBracket">
                    <i class="bi bi-plus-lg me-1"></i>
                    Add Bracket
                </button>
            </div>
            <div class="table-responsive">
            <table class="table table-sm table-borderless mt-2 mb-0">
                <thead>
                    <tr>
                        <th>Value</th>
                        <th>Rate</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var bracket in Config.Taxes.IncomeTaxBrackets ?? new List<IncomeTaxBracket>())
                    {
                        <TaxBracketRow Bracket="bracket" OnRemove="(() => RemoveBracket(bracket))" />
                    }
                </tbody>
            </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                <h6 class="m-0">Social Security Tax Brackets (@(Config.Taxes.SocialSecurityTaxBrackets?.Count ?? 0))</h6>
                <button type="button" class="btn btn-sm btn-cyan-outline" @onclick="AddSocialBracket">
                    <i class="bi bi-plus-lg me-1"></i>
                    Add Bracket
                </button>
            </div>
            <div class="table-responsive">
            <table class="table table-sm table-borderless mt-2 mb-0">
                <thead>
                    <tr>
                        <th>Value</th>
                        <th>Rate</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ss in Config.Taxes.SocialSecurityTaxBrackets ?? new List<IncomeTaxBracket>())
                    {
                        <TaxBracketRow Bracket="ss" OnRemove="(() => RemoveSocialBracket(ss))" />
                    }
                </tbody>
            </table>
            </div>
        </div>

        <div class="border rounded p-2 mt-3">
            <h5 class="mb-2">Salary</h5>
            <div class="row g-2">
                <div class="col-md-4">
                    <label>Annual Gross Salary</label>
                    <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Salary.AnnualGrossSalary" />
                </div>
                <div class="col-md-4">
                    <label>Annual Growth</label>
                    <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Salary.AnnualSalaryGrowthRate" />
                </div>
            </div>
            <div class="row g-2 mt-1">
                <div class="col-md-3">
                    <label>Employee Pension %</label>
                    <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Salary.EmployeePensionContributionRate" />
                </div>
                <div class="col-md-3">
                    <label>Employer Pension %</label>
                    <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Salary.EmployerPensionContributionRate" />
                </div>
                <div class="col-md-3">
                    <label>Employee study fund %</label>
                    <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Salary.EmployeeStudyFundContributionRate" />
                </div>
                <div class="col-md-3">
                    <label>Employer study fund %</label>
                    <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Salary.EmployerStudyFundContributionRate" />
                </div>
            </div>
        </div>

        <div class="border rounded p-2 mt-3">
            <h5 class="mb-2">RSUs</h5>
            <div class="row g-2">
            <div class="col-md-4">
                <label>Annual Grant</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Rsu.AnnualGrantAmount" />
            </div>
            <div class="col-md-4">
                <label>Vesting Years</label>
                <InputNumber TValue="int" class="form-control" @bind-Value="Config.Rsu.VestingYears" />
            </div>
            </div>
        </div>

        <div class="border rounded p-2 mt-3">
            <h5 class="mb-2">Portfolio</h5>
            <div class="row g-2">
            <div class="col-md-4">
                <label>Current Value</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Portfolio.CurrentValue" />
            </div>
            <div class="col-md-4">
                <label>Annual Return</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Portfolio.AnnualReturnRate" />
            </div>
            <div class="col-md-4">
                <label>Pre-Pension Withdrawal Rate</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Portfolio.PrePensionWithdrawalRate" />
            </div>
            </div>
        </div>

        <div class="border rounded p-2 mt-3">
            <h5 class="mb-2">Study fund</h5>
            <div class="row g-2">
            <div class="col-md-3">
                <label>Current Value</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.StudyFund.CurrentValue" />
            </div>
            <div class="col-md-3">
                <label>Annual Return</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.StudyFund.AnnualReturnRate" />
            </div>
            <div class="col-md-3">
                <label>Active From Age</label>
                <InputNumber TValue="int?" class="form-control" @bind-Value="Config.StudyFund.ActiveFromAge" />
            </div>
            <div class="col-md-3">
                <label>Max Annual Contribution</label>
                <InputNumber TValue="decimal?" step="any" class="form-control" @bind-Value="Config.StudyFund.MaxAnnualContribution" />
            </div>
            </div>
        </div>

        <div class="border rounded p-2 mt-3">
            <h5 class="mb-2">Pension</h5>
            <div class="row g-2">
            <div class="col-md-4">
                <label>Current Balance</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Pension.CurrentBalance" />
            </div>
            <div class="col-md-4">
                <label>Return Until Pension</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Pension.AnnualReturnRateUntilPension" />
            </div>
            <div class="col-md-4">
                <label>Annuity Factor</label>
                <InputNumber TValue="int" class="form-control" @bind-Value="Config.Pension.AnnuityFactor" />
            </div>
            </div>
        </div>

        <div class="border rounded p-2 mt-3">
            <h5 class="mb-2">Expenses</h5>
            <div class="row g-2">
            <div class="col-md-6">
                <label>Annual Expenses</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Expenses.AnnualExpenses" />
            </div>
            <div class="col-md-6">
                <label>Annual Expenses Growth</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.Expenses.AnnualExpensesGrowthRate" />
            </div>
            </div>
        </div>

        <div class="border rounded p-2 mt-3">
            <h5 class="mb-2">Additional Net Income</h5>
            <div class="row g-2">
            <div class="col-md-4">
                <label>Annual Net Income</label>
                <InputNumber TValue="decimal" step="any" class="form-control" @bind-Value="Config.AdditionalIncome.AnnualNetIncome" />
            </div>
            </div>
        </div>

        <div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
            @if (ShowCalculate)
            {
                <button type="button" class="btn btn-calc" @onclick="HandleCalculate">
                    <i class="bi bi-calculator-fill me-1"></i>
                    Calculate
                </button>
            }
            @if (ShowSave)
            {
                <button class="btn btn-cyan-outline" type="submit">
                    <i class="bi bi-save me-1"></i>
                    Save
                </button>
            }
            @if (ShowReloadDefaults)
            {
                <button type="button" class="btn btn-cyan-outline" @onclick="OnReloadDefaults">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                    Reload Defaults
                </button>
            }
            <button type="button" class="btn btn-cyan-outline" @onclick="ExportConfig">
                <i class="bi bi-filetype-json me-1"></i>
                Export JSON
            </button>
            <label class="btn btn-cyan-outline mb-0">
                <i class="bi bi-filetype-json me-1"></i>
                Import JSON
                <InputFile OnChange="OnImportSelected" accept="application/json" class="d-none" />
            </label>
        </div>
    </EditForm>
}

@code {
    private static readonly JsonSerializerOptions JsonOptions = new JsonSerializerOptions(JsonSerializerOptions.Web)
    {
        WriteIndented = true
    };

    [Parameter]
    public AppConfig? Config { get; set; }

    [Parameter]
    public bool ShowSave { get; set; } = true;

    [Parameter]
    public bool ShowReloadDefaults { get; set; } = true;

    [Parameter]
    public bool ShowCalculate { get; set; } = false;

    [Parameter]
    public EventCallback<AppConfig> Save { get; set; }

    [Parameter]
    public EventCallback<AppConfig> Calculate { get; set; }

    [Parameter]
    public EventCallback OnReloadDefaults { get; set; }

    private EditContext? _editContext;
    [Inject] private IJSRuntime JS { get; set; } = default!;

    protected override void OnParametersSet()
    {
        if (Config is not null && (_editContext == null || !ReferenceEquals(_editContext.Model, Config)))
        {
            _editContext = new EditContext(Config);
        }
    }

    private async Task HandleSave()
    {
        if (Config is null) return;
        if (_editContext?.Validate() == true)
        {
            await Save.InvokeAsync(Config);
        }
    }

    private async Task HandleCalculate()
    {
        if (Config is null) return;
        if (_editContext?.Validate() == true)
        {
            await Calculate.InvokeAsync(Config);
        }
    }

    private void AddBracket()
    {
        Config!.Taxes.IncomeTaxBrackets ??= new List<IncomeTaxBracket>();
        Config.Taxes.IncomeTaxBrackets.Add(new IncomeTaxBracket { Value = null, Rate = 0 });
    }

    private void RemoveBracket(IncomeTaxBracket bracket)
    {
        Config?.Taxes.IncomeTaxBrackets?.Remove(bracket);
    }

    private void AddSocialBracket()
    {
        Config!.Taxes.SocialSecurityTaxBrackets ??= new List<IncomeTaxBracket>();
        Config.Taxes.SocialSecurityTaxBrackets.Add(new IncomeTaxBracket { Value = null, Rate = 0 });
    }

    private void RemoveSocialBracket(IncomeTaxBracket bracket)
    {
        Config?.Taxes.SocialSecurityTaxBrackets?.Remove(bracket);
    }

    private async Task ExportConfig()
    {
        if (Config is null) return;
        var json = JsonSerializer.Serialize(Config, JsonOptions);
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("pp.saveFile", $"pensionpilot-config-{DateTime.UtcNow:yyyyMMddHHmmss}.json", base64, "application/json");
    }

    private async Task OnImportSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file is null) return;
            await using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024);
            using var reader = new StreamReader(stream);
            var text = await reader.ReadToEndAsync();
            var imported = System.Text.Json.JsonSerializer.Deserialize<AppConfig>(text, JsonOptions);
            if (imported is null)
            {
                await JS.InvokeVoidAsync("alert", "Invalid config file.");
                return;
            }
            imported.Taxes ??= new TaxesSettings();
            imported.Taxes.IncomeTaxBrackets ??= new List<IncomeTaxBracket>();
            imported.Taxes.SocialSecurityTaxBrackets ??= new List<IncomeTaxBracket>();

            Config = imported;
            _editContext = new EditContext(Config);
            await Save.InvokeAsync(Config);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Failed to import config: {ex.Message}");
        }
    }
}
