@page "/"
@using PensionPilot.Models.Config
@inject PensionPilot.Services.IConfigService ConfigService
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components
@using PensionPilot.Services
@inject IJSRuntime JS

<div class="intro-box" role="note" aria-label="About PensionPilot">
    <h1 class="intro-title">
        Pension Pilot
    </h1>
    <ul class="mb-0">
        <li>Simulate retirement finances across portfolio, study fund, pension, salary, and RSUs, including income and capital gains taxes.</li>
        <li>Discover important portfolio milestones, such as potential early retirement age.</li>
        <li>Edit the inputs and click <strong>Calculate</strong> to see year-by-year cashflow and net worth on the results page.</li>
        <li>Inputs are saved in your browser's local storage.</li>
        <li>Use the <strong>Share</strong> button on the results page to get a link that contains your inputs. Opening that link loads a temporary plan, allowing you to either save or discard it.</li>
    </ul>
</div>

@if (_config is null)
{
    <p>Loading...</p>
}
else
{
    <TemporaryConfigBanner IsTemporary="isTemporary" />
    @if (isPreviewMode)
    {
        <div class="alert alert-warning d-flex align-items-center gap-2 mb-3">
            <i class="bi bi-eye-fill"></i>
            <span>You are editing a <strong>preview</strong> of your plan. Changes are not saved yet.</span>
            <button class="btn btn-sm btn-outline-secondary ms-auto" @onclick="DiscardPreview">
                <i class="bi bi-x-circle me-1"></i>
                Discard Preview
            </button>
        </div>
    }
    <div class="pb-4"> <!-- add bottom padding to avoid footer overlap on mobile when disclaimer visible -->
    <InputsForm Config="_config"
                ShowSave="true"
                ShowReloadDefaults="false"
                ShowCalculate="true"
                ShowPreview="@(!isTemporary && !isPreviewMode)"
                Save="OnSave"
                Calculate="OnCalculate"
                Preview="OnPreview"
                OnReloadDefaults="ReloadDefaults" />
    </div>
}

@code {
    private AppConfig? _config;
    private bool isTemporary;
    private bool isPreviewMode;

    [SupplyParameterFromQuery(Name = "share")] public string? Share { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(Share) && ConfigShareHelper.TryDecode(Share, out var imported))
        {
            _config = imported;
            isTemporary = true;
            isPreviewMode = false;
        }
        else if (await ConfigService.HasPreviewConfigAsync())
        {
            _config = await ConfigService.GetPreviewConfigAsync();
            isPreviewMode = true;
            isTemporary = false;
        }
        else
        {
            _config = await ConfigService.GetSavedConfigAsync();
            isPreviewMode = false;
            isTemporary = false;
        }
    }

    private async Task OnSave(AppConfig cfg)
    {
        // Ensure parent state uses the (possibly new) instance from child (e.g. after Import JSON)
        _config = cfg;
        await ConfigService.SetConfigAsync(cfg);
        await ConfigService.ClearPreviewConfigAsync();
        isPreviewMode = false;
        if (isTemporary)
        {
            isTemporary = false;
            Nav.NavigateTo("", forceLoad: false);
        }
        StateHasChanged();
    }

    private async Task OnCalculate(AppConfig cfg)
    {
        if (isTemporary)
        {
            // Do not save yet; navigate with encoded config
            var b64 = ConfigShareHelper.Encode(cfg);
            Nav.NavigateTo($"planner?share={b64}");
            return;
        }
        if (isPreviewMode)
        {
            // In preview mode, save the preview and navigate to planner
            await ConfigService.SetPreviewConfigAsync(cfg);
            Nav.NavigateTo("planner");
            return;
        }
        await ConfigService.SetConfigAsync(cfg);
        Nav.NavigateTo("planner");
    }

    private async Task OnPreview(AppConfig cfg)
    {
        // Save preview config to sessionStorage and navigate to planner
        await ConfigService.SetPreviewConfigAsync(cfg);
        Nav.NavigateTo("planner");
    }

    private async Task DiscardPreview()
    {
        await ConfigService.ClearPreviewConfigAsync();
        isPreviewMode = false;
        _config = await ConfigService.GetSavedConfigAsync();
        StateHasChanged();
    }

    private async Task ReloadDefaults()
    {
        if (isTemporary || isPreviewMode) return;
        await ConfigService.ResetAsync();
        _config = await ConfigService.GetSavedConfigAsync();
        StateHasChanged();
    }
}
